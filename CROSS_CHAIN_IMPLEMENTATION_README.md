# Solana-EVM è·¨é“¾æ¡¥æ¥å®ç°

## æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªç®€åŒ–çš„ Solana-EVM åŒå‘è·¨é“¾æ¡¥æ¥ç³»ç»Ÿã€‚è¯¥ç³»ç»ŸåŸºäºä¸€ä¸ªæ ¸å¿ƒå‡è®¾ï¼š**è·¨é“¾åŒæ–¹æ— æ¡ä»¶ç›¸ä¿¡å¯¹æ–¹ä¼šæˆåŠŸæ‰§è¡Œäº¤æ˜“**ã€‚è¿™æ„å‘³ç€å‘èµ·é“¾åœ¨æ¥æ”¶åˆ°è·¨é“¾è¯·æ±‚åï¼Œä¸å†è¿½è¸ªåç»­çŠ¶æ€ã€‚

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. ä¸¤åŒºå—å®Œæˆæ¨¡å‹
è·¨é“¾äº¤æ˜“é€šè¿‡æ—¶é—´é¡ºåºçš„ä¸¤ä¸ªåŒºå—å®Œæˆï¼š

- **åŒºå— Nï¼ˆè¯·æ±‚åŒºå—ï¼‰**ï¼šæ¥æ”¶å¹¶è®°å½•è·¨é“¾è¯·æ±‚
- **åŒºå— N+1ï¼ˆæ‰§è¡ŒåŒºå—ï¼‰**ï¼šæ‰§è¡Œè·¨é“¾è½¬è´¦

### 2. æ— çŠ¶æ€è¿½è¸ª
- å‘èµ·é“¾ä¸ç»´æŠ¤è·¨é“¾è¯·æ±‚çš„æ‰§è¡ŒçŠ¶æ€
- æ‰§è¡Œç»“æœç”±å…±è¯†å±‚ä¸å†ç»´æŠ¤
- å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œç”±å‘èµ·äººåç»­è‡ªè¡Œå¤„ç†

## å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   EVM Chain     â”‚         â”‚  Consensus      â”‚         â”‚  Solana Chain   â”‚
â”‚                 â”‚         â”‚     Layer       â”‚         â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚         â”‚                 â”‚         â”‚                 â”‚
â”‚  Block N:       â”‚         â”‚  Monitor &      â”‚         â”‚  Block N:       â”‚
â”‚  - User sends   â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Query Events   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”‚  - User sends   â”‚
â”‚    cross-chain  â”‚         â”‚                 â”‚         â”‚    cross-chain  â”‚
â”‚    request      â”‚         â”‚                 â”‚         â”‚    request      â”‚
â”‚                 â”‚         â”‚                 â”‚         â”‚                 â”‚
â”‚  Block N+1:     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Inject Txs     â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Block N+1:     â”‚
â”‚  - Execute      â”‚         â”‚  into Block     â”‚         â”‚  - Execute      â”‚
â”‚    transfers    â”‚         â”‚                 â”‚         â”‚    transfers    â”‚
â”‚                 â”‚         â”‚                 â”‚         â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸¤ä¸ªå…³é”®å®ç°åŠå…¶æŠ€æœ¯æ–¹æ¡ˆ

### 1. è·¨é“¾äº‹ä»¶æŸ¥è¯¢å™¨ (`examples/bridge-consensus-monitor/`)

**å®ç°ç›®æ ‡**ï¼šè·å–åŒºå—ä¸­çš„è·¨é“¾è¯·æ±‚

**æŠ€æœ¯å®ç°æ–¹å¼**ï¼š
- **äº‹ä»¶æ—¥å¿—æŸ¥è¯¢**ï¼šä½¿ç”¨ `eth_getLogs` RPC æ–¹æ³•æŸ¥è¯¢ç‰¹å®šåŒºå—çš„äº‹ä»¶
- **äº‹ä»¶è§£ç **ï¼šé€šè¿‡ `alloy-sol-types` è‡ªåŠ¨è§£ç  Solidity äº‹ä»¶
- **è¿‡æ»¤æœºåˆ¶**ï¼š
  ```rust
  // æ„å»ºäº‹ä»¶è¿‡æ»¤å™¨
  let filter = Filter::new()
      .address(BRIDGE_ADDRESS)           // æŒ‡å®šæ¡¥æ¥åˆçº¦åœ°å€
      .topic0(EVENT_SIGNATURE_HASH)      // æŒ‡å®šäº‹ä»¶ç­¾å
      .from_block(block_number)           // æŒ‡å®šåŒºå—èŒƒå›´
      .to_block(block_number);
  
  // æŸ¥è¯¢å¹¶è§£ç äº‹ä»¶
  let logs = provider.get_logs(&filter).await?;
  let event = BridgeRequestCreated::decode_log(&raw_log)?;
  ```

**æ ¸å¿ƒä»£ç é€»è¾‘**ï¼š
```rust
// main.rs ä¸­çš„å…³é”®å®ç°
async fn query_cross_chain_requests(&self, block_number: u64) -> Result<Vec<CrossChainRequest>> {
    // 1. æ„å»ºäº‹ä»¶ç­¾åå“ˆå¸Œ
    let event_signature = BridgeRequestCreated::SIGNATURE_HASH;
    
    // 2. åˆ›å»ºè¿‡æ»¤å™¨ï¼ŒæŒ‡å®šåŒºå—å’Œåˆçº¦
    let filter = Filter::new()
        .address(BRIDGE_ADDRESS)
        .topic0(event_signature)
        .from_block(block_number)
        .to_block(block_number);
    
    // 3. é€šè¿‡ RPC æŸ¥è¯¢æ—¥å¿—
    let logs = self.provider.get_logs(&filter).await?;
    
    // 4. è§£ææ¯ä¸ªæ—¥å¿—ä¸ºè·¨é“¾è¯·æ±‚
    for log in logs {
        let event = BridgeRequestCreated::decode_log(&log)?;
        // æå– requestId, sender, amount ç­‰ä¿¡æ¯
    }
}
```

**è¾“å‡ºç»“æœ**ï¼š
- è¯·æ±‚ IDã€å‘é€è€…åœ°å€ã€ç›®æ ‡åœ°å€
- è·¨é“¾é‡‘é¢å’Œæ‰‹ç»­è´¹
- åŒºå—å·å’Œäº¤æ˜“å“ˆå¸Œ

### 2. ææ¬¾æœºåˆ¶å®ç° (`examples/new-block-producer/`)

**å®ç°ç›®æ ‡**ï¼šåœ¨æ–°åŒºå—ä¸­å¢åŠ è´¦æˆ·ä½™é¢ï¼ˆå¤„ç† Solana â†’ EVM è·¨é“¾ï¼‰

**æŠ€æœ¯å®ç°æ–¹å¼**ï¼š
- **å…±è¯†å±‚ææ¬¾ï¼ˆWithdrawalï¼‰**ï¼šä½¿ç”¨ä»¥å¤ªåŠçš„åŸç”Ÿææ¬¾æœºåˆ¶
- **Engine API**ï¼šé€šè¿‡ `engine_forkchoiceUpdated` å’Œ `engine_getPayload` æ§åˆ¶åŒºå—ç”Ÿäº§
- **PayloadAttributes**ï¼šåœ¨è½½è·å±æ€§ä¸­åŒ…å«ææ¬¾ä¿¡æ¯

**æ ¸å¿ƒä»£ç é€»è¾‘**ï¼š
```rust
// 1. åˆ›å»ºææ¬¾å¯¹è±¡ï¼ˆWithdrawalï¼‰
let withdrawal = Withdrawal {
    index: 0,                      // ææ¬¾ç´¢å¼•
    validator_index: 0,            // éªŒè¯è€…ç´¢å¼•
    address: target_address,       // æ¥æ”¶åœ°å€
    amount: 1_000_000_000,        // é‡‘é¢ï¼š1 ETH = 1,000,000,000 Gwei
};

// 2. æ„é€ åŒ…å«ææ¬¾çš„ PayloadAttributes
let payload_attributes = PayloadAttributes {
    timestamp,
    prev_randao: B256::ZERO,
    suggested_fee_recipient: Address::ZERO,
    withdrawals: Some(vec![withdrawal]),  // ğŸ‘ˆ å…³é”®ï¼šåŒ…å«ææ¬¾
    parent_beacon_block_root: Some(B256::ZERO),
};

// 3. é€šè¿‡ Engine API è¯·æ±‚æ„å»ºè½½è·
let forkchoice_result = make_rpc_call(
    &client,
    "engine_forkchoiceUpdatedV3",
    json!([forkchoice_state, payload_attributes])  // åŒ…å«ææ¬¾çš„è½½è·å±æ€§
).await?;

// 4. è·å–æ„å»ºçš„è½½è·
let payload = make_rpc_call(
    &client,
    "engine_getPayloadV3",
    json!([payload_id])
).await?;

// 5. éªŒè¯å¹¶æäº¤è½½è·
let new_payload_result = make_rpc_call(
    &client,
    "engine_newPayloadV3",
    json!([execution_payload])
).await?;

// 6. è®¾ç½®æ–°åŒºå—ä¸ºé“¾å¤´
let final_result = make_rpc_call(
    &client,
    "engine_forkchoiceUpdatedV3",
    json!([new_forkchoice_state, null])
).await?;
```

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š

1. **ææ¬¾æœºåˆ¶åŸç†**ï¼š
   - ææ¬¾æ˜¯ä»¥å¤ªåŠå…±è¯†å±‚çš„åŸç”ŸåŠŸèƒ½
   - æ¯ä¸ªææ¬¾åŒ…å«éªŒè¯è€…ç´¢å¼•ã€åœ°å€å’Œé‡‘é¢ï¼ˆGweiï¼‰
   - ææ¬¾åœ¨åŒºå—æ‰§è¡Œæ—¶è‡ªåŠ¨å¢åŠ ç›®æ ‡åœ°å€ä½™é¢
   - æ— éœ€ gas è´¹ç”¨ï¼Œç”±å…±è¯†å±‚ç›´æ¥å¤„ç†

2. **Engine API æµç¨‹**ï¼š
   ```
   æ„é€ ææ¬¾ â†’ forkchoiceUpdatedï¼ˆè¯·æ±‚æ„å»ºï¼‰â†’ getPayloadï¼ˆè·å–è½½è·ï¼‰
   â†’ newPayloadï¼ˆéªŒè¯ï¼‰â†’ forkchoiceUpdatedï¼ˆå‡ºå—ï¼‰
   ```

3. **é‡‘é¢å•ä½è½¬æ¢**ï¼š
   - ææ¬¾é‡‘é¢å•ä½æ˜¯ **Gwei**ï¼ˆ1 ETH = 10^9 Gweiï¼‰
   - ä¸æ˜¯ Weiï¼ˆ1 ETH = 10^18 Weiï¼‰
   - ä¾‹å¦‚ï¼š1 ETH = 1,000,000,000 Gwei

4. **éªŒè¯ææ¬¾ç”Ÿæ•ˆ**ï¼š
   ```rust
   // æŸ¥è¯¢ä½™é¢å˜åŒ–
   let balance_before = eth_getBalance(address);
   // ... æ‰§è¡Œææ¬¾ ...
   let balance_after = eth_getBalance(address);
   let change = balance_after - balance_before;
   // åº”è¯¥å¢åŠ  1 ETH
   ```

## å®ç°æ•ˆæœæ€»ç»“

### æ•ˆæœ 1ï¼šæŸ¥è¯¢è·¨é“¾è¯·æ±‚
**å®ç°æ–¹å¼**ï¼šé€šè¿‡ RPC çš„ `eth_getLogs` æ–¹æ³•é…åˆäº‹ä»¶è§£ç 
- æ— éœ€ç»´æŠ¤é“¾ä¸ŠçŠ¶æ€
- å¯æŸ¥è¯¢ä»»æ„å†å²åŒºå—
- äº‹ä»¶æ•°æ®å®Œæ•´å¯é 

### æ•ˆæœ 2ï¼šå¢åŠ è´¦æˆ·ä½™é¢
**å®ç°æ–¹å¼**ï¼šé€šè¿‡å…±è¯†å±‚ Withdrawalï¼ˆææ¬¾ï¼‰æœºåˆ¶
- ä½¿ç”¨ä»¥å¤ªåŠåŸç”Ÿçš„ææ¬¾åŠŸèƒ½
- é€šè¿‡ Engine API æ§åˆ¶åŒºå—ç”Ÿäº§
- é›¶ gas è´¹ç”¨ï¼Œå…±è¯†å±‚ç›´æ¥å¤„ç†
- é‡‘é¢å•ä½ä¸º Gweiï¼ˆé Weiï¼‰

## è·¨é“¾æµç¨‹

### EVM â†’ Solana

1. **ç”¨æˆ·å‘èµ·**ï¼š
   ```bash
   cast send \
     --value 0.1ether \
     0x0000000000000000000000000000000000001000 \
     "bridgeToSolana(bytes32)" \
     0x0101010101010101010101010101010101010101010101010101010101010101
   ```

2. **åŒºå— N**ï¼š
   - æ¡¥æ¥åˆçº¦æ¥æ”¶è¯·æ±‚
   - å‘å‡º `BridgeRequestCreated` äº‹ä»¶
   - æ‰£é™¤ 0.3% æ‰‹ç»­è´¹

3. **å…±è¯†å±‚å¤„ç†**ï¼š
   - ä½¿ç”¨ `bridge-consensus-monitor` æŸ¥è¯¢åŒºå— N çš„äº‹ä»¶
   - æå–è·¨é“¾è¯·æ±‚ä¿¡æ¯
   - å‡†å¤‡ Solana ç«¯æ‰§è¡Œ

4. **åŒºå— N+1ï¼ˆSolanaï¼‰**ï¼š
   - æ‰§è¡Œè½¬è´¦åˆ°ç›®æ ‡åœ°å€
   - é‡‘é¢ = åŸå§‹é‡‘é¢ - æ‰‹ç»­è´¹

### Solana â†’ EVM

1. **ç”¨æˆ·å‘èµ·**ï¼š
   - åœ¨ Solana ç«¯å‘èµ·è·¨é“¾è¯·æ±‚

2. **åŒºå— Nï¼ˆSolanaï¼‰**ï¼š
   - è®°å½•è·¨é“¾è¯·æ±‚

3. **å…±è¯†å±‚å¤„ç†**ï¼š
   - æŸ¥è¯¢ Solana åŒºå—çš„è·¨é“¾è¯·æ±‚
   - é€šçŸ¥ EVM ç«¯çš„ `new-block-producer`

4. **åŒºå— N+1ï¼ˆEVMï¼‰**ï¼š
   - `new-block-producer` é€šè¿‡ææ¬¾æœºåˆ¶å¢åŠ ä½™é¢
   - åœ¨ PayloadAttributes ä¸­åŒ…å« Withdrawal å¯¹è±¡
   - å…±è¯†å±‚è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€ gas è´¹ç”¨

## æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨ Reth èŠ‚ç‚¹
```bash
./target/release/reth node \
  --chain dev \
  --http \
  --http.api all
```

### 2. éƒ¨ç½²æ¡¥æ¥åˆçº¦
```bash
./setup_bridge.sh
```

### 3. å‘é€æµ‹è¯•è·¨é“¾äº¤æ˜“
```bash
# EVM â†’ Solana
cast send \
  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
  --value 0.1ether \
  0x0000000000000000000000000000000000001000 \
  "bridgeToSolana(bytes32)" \
  0x0101010101010101010101010101010101010101010101010101010101010101
```

### 4. æŸ¥è¯¢è·¨é“¾äº‹ä»¶
```bash
cd examples/bridge-consensus-monitor
cargo run
```

### 5. è¿è¡ŒåŒºå—ç”Ÿäº§è€…ï¼ˆå¤„ç† Solana â†’ EVMï¼‰
```bash
cd examples/new-block-producer
cargo run
```

## å…³é”®ç‰¹æ€§

1. **æ— çŠ¶æ€è®¾è®¡**ï¼šåˆçº¦ä¸å­˜å‚¨ä»»ä½•è·¨é“¾è¯·æ±‚çŠ¶æ€ï¼Œä»…é€šè¿‡äº‹ä»¶è®°å½•
2. **è‡ªåŠ¨æ‰‹ç»­è´¹**ï¼š0.3% æ‰‹ç»­è´¹è‡ªåŠ¨è®¡ç®—å’Œæ‰£é™¤
3. **ç³»ç»Ÿäº¤æ˜“**ï¼šSolana â†’ EVM é€šè¿‡ç³»ç»Ÿäº¤æ˜“å®ç°ï¼Œæ— éœ€ gas
4. **äº‹ä»¶é©±åŠ¨**ï¼šæ‰€æœ‰è·¨é“¾ä¿¡æ¯é€šè¿‡äº‹ä»¶æŸ¥è¯¢è·å–
5. **ç®€åŒ–ä¿¡ä»»æ¨¡å‹**ï¼šåŒæ–¹æ— æ¡ä»¶ä¿¡ä»»æ‰§è¡Œï¼Œä¸è¿½è¸ªçŠ¶æ€

## æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œä¿è¯**ï¼šç³»ç»Ÿå‡è®¾è·¨é“¾æ‰§è¡Œæ€»æ˜¯æˆåŠŸï¼Œä¸æä¾›å¤±è´¥å¤„ç†æœºåˆ¶
2. **æ‰‹ç»­è´¹**ï¼šå›ºå®š 0.3% æ‰‹ç»­è´¹ï¼Œä¸å¯é…ç½®
3. **åŒºå—ä¾èµ–**ï¼šè·¨é“¾å®Œæˆä¾èµ–äºè¿ç»­çš„ä¸¤ä¸ªåŒºå—
4. **å…±è¯†å±‚è´£ä»»**ï¼šå…±è¯†å±‚è´Ÿè´£æŸ¥è¯¢å’Œä¼ é€’è·¨é“¾ä¿¡æ¯ï¼Œä½†ä¸ç»´æŠ¤æ‰§è¡ŒçŠ¶æ€

## æ–‡ä»¶ç»“æ„

```
.
â”œâ”€â”€ bridge-contracts/                    # æ¡¥æ¥åˆçº¦
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ SolanaEVMBridge.sol         # EVM ç«¯æ¡¥æ¥åˆçº¦
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ bridge-consensus-monitor/       # å…±è¯†å±‚ç›‘æ§å™¨
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â””â”€â”€ main.rs                # æŸ¥è¯¢è·¨é“¾äº‹ä»¶ï¼ˆeth_getLogsï¼‰
â”‚   â””â”€â”€ new-block-producer/            # åŒºå—ç”Ÿäº§è€…
â”‚       â””â”€â”€ src/
â”‚           â””â”€â”€ main.rs                # ææ¬¾æœºåˆ¶å®ç°ï¼ˆWithdrawal via Engine APIï¼‰
â”œâ”€â”€ crates/
â”‚   â””â”€â”€ ethereum/
â”‚       â””â”€â”€ evm/
â”‚           â””â”€â”€ src/
â”‚               â””â”€â”€ lib.rs             # EVM æ‰§è¡Œå™¨ï¼ˆå·²ç§»é™¤ withdrawal_executorï¼‰
â””â”€â”€ setup_bridge.sh                    # åˆçº¦éƒ¨ç½²è„šæœ¬
```

## æ›´æ–°æ—¥å¿—

### æœ€æ–°æ›´æ–°
- âœ… ç§»é™¤äº†æ‰€æœ‰çŠ¶æ€å­˜å‚¨æœºåˆ¶
- âœ… ç®€åŒ–ä¸ºçº¯äº‹ä»¶é©±åŠ¨æ¶æ„
- âœ… ç§»é™¤äº† `withdrawal_executor` æ¨¡å—
- âœ… å®ç°äº†å…±è¯†å±‚äº‹ä»¶æŸ¥è¯¢å™¨ï¼ˆé€šè¿‡ eth_getLogsï¼‰
- âœ… å®Œæˆäº†ææ¬¾æœºåˆ¶å®ç°ï¼ˆé€šè¿‡ Withdrawal å’Œ Engine APIï¼‰

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ç›¸åº”è´Ÿè´£äººï¼š
- EVM ä¾§å®ç°ï¼š[EVM è´Ÿè´£äºº]
- Solana ä¾§å®ç°ï¼š[Solana è´Ÿè´£äºº]
- å…±è¯†å±‚é›†æˆï¼š[å…±è¯†å±‚è´Ÿè´£äºº]